#include <mbusafecrt.h>
#include "jvm_t.h"

/*
 * This library (along with the other libraries required by the enclave) are all built into
 * a partial enclave that is finally linked when the enclave is built. This can result in
 * functions being discarded by the linker that may ultimately be required by the final
 * enclave file. The static function below is used to add a reference to the functions
 * required by this module in the code generated by the edl file - these functions are
 * only called by the final enclave and are therefore discarded.
 * 
 * Note that at the moment this is only relevant when building a release build of the 
 * enclave as debug builds include debug_print() in the edl which is called by other
 * static libraries in the partial enclave resulting in the dependent functions not
 * being discarded.
 * 
 * This function is never actually called.
 */
static __attribute__((used)) void keep_functions() {
    memcpy_s(0, 0, 0, 0);
}

extern "C" {

/*
 * In release mode enclaves, we want to prevent calls to the debug print edl function, so that
 * prints do not propagate out of the enclave. As such, the debug_print_edl should not be called
 * anywhere except here. When something needs to be logged from inside the enclave, this function
 * should *always* be called instead.
 * The purpose of allow_debug_print parameter here is to ensure that caller is aware that debug
 * prints must take the enclave mode into account.
 */
void debug_print_enclave(const char* msg, int length, bool allow_debug_print) {
    if (allow_debug_print) {
        debug_print_edl(msg, length);
    }
}

} // extern "C"
