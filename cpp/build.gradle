import javax.inject.Inject

apply plugin: "base"

def types = ["Simulation", "Debug", "Release"]

configurations {
    javah_host
    javah_enclave
}

dependencies {
    javah_host project(":api-core:api-core-host")
    javah_enclave project(":api-core:api-core-enclave")
}

task generateHostJniHeaders(type: Javah, constructorArgs: ['com.r3.sgx.core.host.internal.Native']) {
    dependsOn(configurations["javah_host"])
    inputJar = configurations["javah_host"].files.first()
    outputHeader = file("$projectDir/jvm-host/include/host_jni.h")
}

task generateEnclaveJniHeaders(type: Javah, constructorArgs: ['com.r3.sgx.core.enclave.internal.Native']) {
    dependsOn(configurations["javah_enclave"])
    inputJar = configurations["javah_enclave"].files.first()
    outputHeader = file("$projectDir/jvm-enclave-common/include/enclave_jni.h")
}

String buildDirectory(type) { return "$buildDir/$type" }
static String createCmakeTaskName(type) { return "createCmakeBuild$type" }
static String compileTaskNameEnclave(type) { return "compileEnclave$type" }
static String compileTaskNameHost(type) { return "compileHost$type" }
static String compileTaskNameLinuxSgx(type) { return "compileLinuxSgx$type" }

def maxWorkers = properties["org.gradle.workers.max"]

for (type in types) {
    // Use Cmake to create build
    tasks.create(createCmakeTaskName(type), Exec) {
        environment["CMAKE_BUILD_PARALLEL_LEVEL"] = "$maxWorkers"
        workingDir(buildDirectory(type))

        commandLine("/usr/bin/env", "cmake", "-DCMAKE_BUILD_TYPE=$type", projectDir)

        inputs.files(
                "$projectDir/CMakeLists.txt",
                "$projectDir/*/CMakeLists.txt"
        )

        outputs.files(
                "${buildDirectory(type)}/Makefile"
        )
    }

    // Build the enclave object
    tasks.create(compileTaskNameEnclave(type), Exec) {
        dependsOn(compileTaskNameLinuxSgx(type), createCmakeTaskName(type), generateEnclaveJniHeaders)


        environment["CMAKE_BUILD_PARALLEL_LEVEL"] = "$maxWorkers"
        workingDir(buildDirectory(type))

        commandLine("/usr/bin/env", "cmake",
                "--build", buildDirectory(type),
                "--target", "jvm_enclave_avian"
        )

        inputs.files(
                "${buildDirectory(type)}/Makefile",
                "$projectDir/jvm-edl/CMakeList.txt"
        )
        // May need to add more here, for now this is good enough
        inputs.dir("$projectDir/avian/src") // src/ because avian puts stuff in avian/build/, failing the up-to-date check
        inputs.dir("$projectDir/jvm-edl/src")
        inputs.dir("$projectDir/jvm-enclave-avian")
        inputs.dir("$projectDir/jvm-enclave-common")
        inputs.dir("$projectDir/jvm-host-enclave-common")

        outputs.files("${buildDirectory(type)}/jvm-enclave-avian/jvm_enclave_avian")
    }

    // Build the host object
    tasks.create(compileTaskNameHost(type), Exec) {
        dependsOn(compileTaskNameLinuxSgx(type), createCmakeTaskName(type), generateHostJniHeaders)

        environment["CMAKE_BUILD_PARALLEL_LEVEL"] = "$maxWorkers"
        workingDir(buildDirectory(type))

        commandLine("/usr/bin/env", "cmake",
                "--build", buildDirectory(type),
                "--target", "jvm_host"
        )

        inputs.files(
                "${buildDirectory(type)}/Makefile"
        )
        inputs.dir("$projectDir/jvm-host")
        inputs.dir("$projectDir/jvm-host-enclave-common")
        outputs.files("${buildDirectory(type)}/jvm-host/libjvm_host.so")
    }

    tasks.create(compileTaskNameLinuxSgx(type), Exec) {
        dependsOn(createCmakeTaskName(type))

        environment["CMAKE_BUILD_PARALLEL_LEVEL"] = "$maxWorkers"
        workingDir(buildDirectory(type))

        commandLine("/usr/bin/env", "cmake",
                "--build", buildDirectory(type),
                "--target", "linux-sgx-ext"
        )

        inputs.files(
                "${buildDirectory(type)}/Makefile"
        )

        outputs.dir("${buildDirectory(type)}/linux-sgx")
    }
}

task cleanAvian(type: Delete) {
    delete "$projectDir/avian/build"
}

clean.finalizedBy cleanAvian

class Javah extends DefaultTask {
    final String nativeClass

    @OutputFile
    File outputHeader
    @InputFile
    File inputJar

    @Inject
    Javah(String nativeClass) {
        this.nativeClass = nativeClass
    }

    @TaskAction
    def run() {
        project.exec { spec ->
            spec.workingDir(temporaryDir)
            spec.commandLine("/usr/bin/env", "javah",
                "-o", outputHeader,
                "-cp", inputJar,
                nativeClass
            )
        }
    }
}
